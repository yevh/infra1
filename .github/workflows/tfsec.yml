name: tfsec Security Scan

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  issues: write
  pull-requests: write

jobs:
  tfsec:
    name: Run tfsec Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install tfsec
        shell: bash {0}
        run: |
          mkdir -p $HOME/.local/bin
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash -s -- -b $HOME/.local/bin

      - name: Add tfsec to PATH
        shell: bash {0}
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run tfsec
        id: tfsec
        continue-on-error: true
        shell: bash {0}
        run: |
          tfsec . --format json > tfsec_output.json
          cat tfsec_output.json

      - name: Check for Issues and Prepare Summary
        if: always()
        id: check
        shell: bash {0}
        run: |
          set +e
          if [ -f tfsec_output.json ]; then
            CRITICAL_COUNT=$(jq '[.results[] | select(.severity=="CRITICAL")] | length' tfsec_output.json)
            HIGH_COUNT=$(jq '[.results[] | select(.severity=="HIGH")] | length' tfsec_output.json)
            MEDIUM_COUNT=$(jq '[.results[] | select(.severity=="MEDIUM")] | length' tfsec_output.json)
            LOW_COUNT=$(jq '[.results[] | select(.severity=="LOW")] | length' tfsec_output.json)
            TOTAL_ISSUES=$((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))
            if [ "$TOTAL_ISSUES" -gt 0 ]; then
              SUMMARY="üö® **Issues found!**
              **Total issues:** $TOTAL_ISSUES (üî¥ Critical: $CRITICAL_COUNT, üü£ High: $HIGH_COUNT, üü° Medium: $MEDIUM_COUNT, üü¢ Low: $LOW_COUNT)"
              echo "findings_summary<<EOF" >> $GITHUB_OUTPUT
              echo "$SUMMARY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              SUMMARY="‚úÖ **No security issues found!**"
              echo "findings_summary<<EOF" >> $GITHUB_OUTPUT
              echo "$SUMMARY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
              echo "issues_found=true" >> $GITHUB_OUTPUT
            else
              echo "issues_found=false" >> $GITHUB_OUTPUT
            fi
          else
            SUMMARY="‚ö†Ô∏è **tfsec output not found.**"
            echo "findings_summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "issues_found=false" >> $GITHUB_OUTPUT
          fi
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "Note: Cannot post findings summary as a comment because the PR is from a fork."
          fi

      - name: Comment Findings Summary on PR
        if: >
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ${{ steps.check.outputs.findings_summary }}

      - name: Print Detailed Findings
        if: always()
        shell: bash {0}
        run: |
          if [ -f tfsec_output.json ]; then
            echo "## Detailed Findings"
            jq -r '.results[] | "Severity: \(.severity)\nRule ID: \(.rule_id)\nDescription: \(.description)\nFile: \(.location.filename):\(.location.start_line)-\(.location.end_line)\n\n"' tfsec_output.json
          else
            echo "tfsec_output.json not found. No detailed findings to display."
          fi

      - name: Fail Job if Critical or High Issues Found
        if: steps.check.outputs.issues_found == 'true'
        run: exit 1
