name: tfsec
on:
  push:
    branches:
      - master
  pull_request:

jobs:
  tfsec:
    name: tfsec
    runs-on: ubuntu-latest
    steps:
      - name: Clone repo
        uses: actions/checkout@v4

      - name: Install tfsec
        shell: bash {0}
        run: |
          # Install tfsec
          mkdir -p $HOME/.local/bin
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash -s -- -b $HOME/.local/bin

      - name: Add tfsec to PATH
        shell: bash {0}
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run tfsec
        id: tfsec
        continue-on-error: true
        shell: bash {0}
        run: |
          # Run tfsec and save output to a file in JSON format
          tfsec . --format json > tfsec_output.json
          # Display the output in the logs
          cat tfsec_output.json

      - name: Generate summary
        if: always()
        shell: bash {0}
        run: |
          echo "# 🔒 tfsec Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if tfsec_output.json exists
          if [ -f tfsec_output.json ]; then
            # Parse JSON output and calculate counts
            CRITICAL=$(jq '[.results[] | select(.severity=="CRITICAL")] | length' tfsec_output.json)
            HIGH=$(jq '[.results[] | select(.severity=="HIGH")] | length' tfsec_output.json)
            MEDIUM=$(jq '[.results[] | select(.severity=="MEDIUM")] | length' tfsec_output.json)
            LOW=$(jq '[.results[] | select(.severity=="LOW")] | length' tfsec_output.json)
            PASSED="N/A"

            # Write summary
            echo "## Summary" >> $GITHUB_STEP_SUMMARY
            echo "✅ Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "🚨 Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
            echo "ℹ️ Low: $LOW" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract and format findings (limit to critical and high severity for brevity)
            echo "## Findings" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            jq -r '.results[] | select(.severity == "CRITICAL" or .severity == "HIGH") | "\(.severity): \(.description)\nFile: \(.location.filename):\(.location.start_line)\n"' tfsec_output.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            # Export the CRITICAL variable for use in the next step
            echo "CRITICAL=$CRITICAL" >> $GITHUB_ENV
          else
            echo "No tfsec output found."
          fi

      - name: Check for critical issues
        if: always()
        shell: bash {0}
        run: |
          # Delay job failure until after summary is generated
          if [ "${CRITICAL:-0}" -gt 0 ]; then
            echo "🚨 Critical security issues found!"
            # Set a GitHub Actions output variable to indicate failure
            echo "::set-output name=critical_issues_found::true"
          else
            echo "::set-output name=critical_issues_found::false"
          fi

      # This step will fail the job if critical issues were found
      - name: Fail job if critical issues found
        if: steps.check.outputs.critical_issues_found == 'true'
        run: exit 1
