name: tfsec Security Scan

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  issues: write
  pull-requests: write

jobs:
  tfsec:
    name: Run tfsec Security Scan
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Install tfsec
      - name: Install tfsec
        shell: bash {0}
        run: |
          mkdir -p $HOME/.local/bin
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash -s -- -b $HOME/.local/bin

      # 3. Add tfsec to PATH
      - name: Add tfsec to PATH
        shell: bash {0}
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # 4. Run tfsec and save output
      - name: Run tfsec
        id: tfsec
        continue-on-error: true
        shell: bash {0}
        run: |
          # Run tfsec and save output to a file in JSON format
          tfsec . --format json > tfsec_output.json
          # Display the output in the logs
          cat tfsec_output.json

      # 5. Check for Issues and Prepare Summary
      - name: Check for Issues and Prepare Summary
        if: always()
        id: check
        shell: bash {0}
        run: |
          set +e  # Continue script even if a command fails

          if [ -f tfsec_output.json ]; then
            # Extract counts using jq
            CRITICAL_COUNT=$(jq '[.results[] | select(.severity=="CRITICAL")] | length' tfsec_output.json)
            HIGH_COUNT=$(jq '[.results[] | select(.severity=="HIGH")] | length' tfsec_output.json)
            MEDIUM_COUNT=$(jq '[.results[] | select(.severity=="MEDIUM")] | length' tfsec_output.json)
            LOW_COUNT=$(jq '[.results[] | select(.severity=="LOW")] | length' tfsec_output.json)
            TOTAL_ISSUES=$((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))

            if [ "$TOTAL_ISSUES" -gt 0 ]; then
              # Construct the Markdown summary for issues found
              SUMMARY="üö® **Issues found!**
              **Total issues:** $TOTAL_ISSUES (üî¥ Critical: $CRITICAL_COUNT, üü£ High: $HIGH_COUNT, üü° Medium: $MEDIUM_COUNT, üü¢ Low: $LOW_COUNT)"

              # Set the summary as an output variable
              echo "findings_summary<<EOF" >> $GITHUB_OUTPUT
              echo "$SUMMARY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              # Construct the Markdown summary for no issues found
              SUMMARY="‚úÖ **No security issues found!**"

              # Set the summary as an output variable
              echo "findings_summary<<EOF" >> $GITHUB_OUTPUT
              echo "$SUMMARY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi

            # Determine if the job should fail
            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
              echo "issues_found=true" >> $GITHUB_OUTPUT
            else
              echo "issues_found=false" >> $GITHUB_OUTPUT
            fi
          else
            # Handle missing tfsec_output.json
            SUMMARY="‚ö†Ô∏è **tfsec output not found.**"

            # Set the summary as an output variable
            echo "findings_summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Indicate no issues found due to missing output
            echo "issues_found=false" >> $GITHUB_OUTPUT
          fi

          # Notify in logs if the PR is from a fork
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "Note: Cannot post findings summary as a comment because the PR is from a fork."
          fi

      # 6. Debug Step (Optional)
      - name: Debug Findings Summary
        if: github.event_name == 'pull_request'
        run: echo "${{ steps.check.outputs.findings_summary }}"

      # 7. Post Comment to PR
      - name: Comment Findings Summary on PR
        if: >
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ${{ steps.check.outputs.findings_summary }}

      # 8. Fail the Job if Critical or High Issues Found
      - name: Fail Job if Critical or High Issues Found
        if: steps.check.outputs.issues_found == 'true'
        run: exit 1
