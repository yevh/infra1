name: tfsec
on:
  push:
    branches:
      - master
  pull_request:

jobs:
  tfsec:
    name: tfsec
    runs-on: ubuntu-latest
    steps:
      - name: Clone repo
        uses: actions/checkout@v4

      - name: Run tfsec
        id: tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        continue-on-error: true

      - name: Generate summary
        if: success() || failure()
        shell: bash
        run: |
          echo "# 🔒 tfsec Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract the numbers from tfsec output
          STATS=$(echo '${{ steps.tfsec.outputs.stdout }}' | grep -A 7 "^results$")
          PASSED=$(echo "$STATS" | grep "passed" | awk '{print $2}')
          CRITICAL=$(echo "$STATS" | grep "critical" | awk '{print $2}')
          HIGH=$(echo "$STATS" | grep "high" | awk '{print $2}')
          MEDIUM=$(echo "$STATS" | grep "medium" | awk '{print $2}')
          LOW=$(echo "$STATS" | grep "low" | awk '{print $2}')
          
          # Write summary
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "🚨 Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ High: $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
          echo "ℹ️ Low: $LOW" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract and format findings
          echo "## Findings" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.tfsec.outputs.stdout }}' | sed -n '/Problem/,/timings/p' | grep -v "timings" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # Set exit flag for critical issues
          if [ "$CRITICAL" -gt 0 ]; then
            echo "has_critical=true" >> $GITHUB_ENV
          fi

      - name: Check for critical issues
        if: env.has_critical == 'true'
        run: |
          echo "🚨 Critical security issues found!"
          exit 1
